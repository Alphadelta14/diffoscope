#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# diffoscope: in-depth comparison of files, archives, and directories
#
# Copyright Â© 2016 Chris Lamb <lamby@debian.org>
#
# diffoscope is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# diffoscope is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with diffoscope.  If not, see <http://www.gnu.org/licenses/>.

import os
import sys
import argparse
import requests

class TryDiffoscope(object):
    def __init__(self, args):
        self.args = args

    def main(self):
        response = requests.post(self.args.url, files={
            'file_a': open(self.args.file[0], 'rb'),
            'file_b': open(self.args.file[1], 'rb'),
        })

        response.raise_for_status()

        print(response.json()['url'])

        return 0

if __name__ == '__main__':
    parser = argparse.ArgumentParser()

    parser.add_argument(
        'file',
        help="Files to compare",
        nargs=2,
        default=[],
    )

    parser.add_argument(
        '--url',
        help="Use this trydiffoscope endpoint (for development)",
        default='https://try.diffoscope.org/api/v1/compare',
    )

    args = parser.parse_args()

    for x in args.file:
        if not os.path.exists(x):
            parser.error("{}: does not exist".format(x))

    try:
        sys.exit(TryDiffoscope(args).main())
    except KeyboardInterrupt:
        sys.exit(1)
